---
# Start ksushy BMC simulator for fencing support

- name: Check if ksushy service is already running
  ansible.builtin.systemd:
    name: ksushy.service
    scope: user
  register: ksushy_service
  failed_when: false
  changed_when: false

- name: Set ksushy running status
  set_fact:
    ksushy_running: "{{ ksushy_service.status.ActiveState | default('inactive') == 'active' }}"

- name: Create ksushy systemd service
  shell: "KSUSHY_LISTEN_PORT={{ ksushy_port }} kcli create sushy-service"
  when: not ksushy_running

- name: Ensure firewall allows ksushy port
  ansible.posix.firewalld:
    port: "{{ ksushy_port }}/tcp"
    zone: libvirt
    permanent: true
    immediate: true
    state: enabled
  become: true
  when: not ksushy_running

- name: Wait for ksushy to start
  wait_for:
    port: "{{ ksushy_port }}"
    host: "{{ ksushy_ip }}"
    delay: 2
    timeout: 30
  when: not ksushy_running

- name: Display ksushy status
  debug:
    msg: |
      {% if ksushy_running %}
      ksushy BMC simulator was already running
      {% else %}
      ksushy BMC simulator started successfully on {{ ksushy_ip }}:{{ ksushy_port }}
      {% endif %}
      
      BMC endpoints for {{ test_cluster_name }}:
      - https://{{ ksushy_ip }}:{{ ksushy_port }}/redfish/v1/Systems/{{ test_cluster_name }}-ctlplane-0
      - https://{{ ksushy_ip }}:{{ ksushy_port }}/redfish/v1/Systems/{{ test_cluster_name }}-ctlplane-1
      
- name: Test ksushy BMC endpoint accessibility
  shell: "curl -s -k 'https://{{ ksushy_ip }}:{{ ksushy_port }}/redfish/v1/Systems/local' --connect-timeout 5 | head -1"
  register: ksushy_test
  failed_when: false

- name: Fail if ksushy is not accessible
  fail:
    msg: |
      WARNING: ksushy BMC simulator is not accessible at https://{{ ksushy_ip }}:{{ ksushy_port }}
      
      This will prevent STONITH fencing from working properly. Please check:
      1. ksushy service status: systemctl --user status ksushy.service
      2. Firewall configuration: firewall-cmd --list-ports --zone=libvirt
      3. Network connectivity from VMs to hypervisor IP
      
      Test result: {{ ksushy_test.stdout | default('No response') }}
      Return code: {{ ksushy_test.rc }}
  when: ksushy_test.rc != 0

