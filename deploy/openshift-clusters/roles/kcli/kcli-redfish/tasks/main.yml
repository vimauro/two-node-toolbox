---
# kcli-redfish role main tasks
# Configures stonith fencing for kcli-deployed clusters

- name: Install prerequisites
  include_tasks: prerequisites.yml

- name: Load kcli configuration variables for consistent configuration
  include_vars:
    file: "{{ playbook_dir }}/vars/main.yml"

- name: Set default ksushy IP if not defined
  set_fact:
    ksushy_ip: "192.168.122.1"
  when: ksushy_ip is not defined or ksushy_ip == ""

- name: Display configuration
  debug:
    msg: |
      kcli fencing configuration:
      Cluster Name: {{ test_cluster_name }}
      Hypervisor IP: {{ ksushy_ip }}
      BMC User: {{ bmc_user }}
      BMC Port: {{ ksushy_port }}
      
      Override with: ansible-playbook kcli-redfish.yml -e "test_cluster_name=my-cluster" -e "ksushy_ip=X.X.X.X"

- name: Start ksushy BMC simulator
  include_tasks: start_ksushy.yml

- name: Validate configuration
  assert:
    that:
      - test_cluster_name != ""
      - ksushy_ip != ""
      - bmc_user != ""
      - bmc_password != ""
    fail_msg: |
      Missing required configuration:
      - Cluster name: {{ test_cluster_name }}
      - Hypervisor IP: {{ ksushy_ip }}
      - BMC User: {{ bmc_user }}
      - BMC Password: [{{ 'SET' if bmc_password != '' else 'MISSING' }}]
  delegate_to: localhost 