---
# Create proxy environment configuration

- name: Create proxy environment file
  copy:
    content: |
      # Determine the directory where this proxy.env file is located
      PROXY_ENV_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"

      export EC2_PUBLIC_IP={{ hostvars[inventory_hostname]['inventory_hostname'].split('@')[1] }}
      export PROXYPORT={{ proxy_port }}
      export HTTP_PROXY=http://${EC2_PUBLIC_IP}:${PROXYPORT}/
      export HTTPS_PROXY=http://${EC2_PUBLIC_IP}:${PROXYPORT}/
      export NO_PROXY="{{ proxy_no_proxy_list }}"

      export http_proxy=http://${EC2_PUBLIC_IP}:${PROXYPORT}/
      export https_proxy=http://${EC2_PUBLIC_IP}:${PROXYPORT}/
      export no_proxy="{{ proxy_no_proxy_list }}"

      # Set KUBECONFIG to the absolute path of kubeconfig file next to this proxy.env
      export KUBECONFIG="${PROXY_ENV_DIR}/kubeconfig"

      # K8S_AUTH_PROXY for ansible kubernetes.core collection
      export K8S_AUTH_PROXY=http://${EC2_PUBLIC_IP}:${PROXYPORT}/

      # Display helpful information when sourced
      echo "Proxy environment loaded from: ${PROXY_ENV_DIR}"
      echo "KUBECONFIG set to: ${KUBECONFIG}"

      # Verify kubeconfig exists
      if [[ ! -f "${KUBECONFIG}" ]]; then
          echo "Warning: KUBECONFIG file not found at ${KUBECONFIG}"
          echo "Make sure you're sourcing this file from the correct location or that the kubeconfig file exists."
      else
          echo "âœ“ KUBECONFIG file found"
      fi
    dest: "./proxy.env"
  delegate_to: localhost
