- hosts: metal_machine
  gather_facts: no
  force_handlers: yes

  # --- Variable Definitions ---
  vars:
    # By default, run in interactive mode. Automation will override this.
    interactive_mode: true
    # Set default installation mode for normal installations
    install_dev_mode: "install"
    supported_topologies_pretty_print: "{{', '.join(supported_topologies[:-1]) }} {{ 'and' if (supported_topologies | length) > 2 else 'or' }} {{ supported_topologies[-1] }}"
    supported_methods_pretty_print: "{{', '.join(supported_methods[:-1]) }} {{ 'and' if (supported_methods | length) > 2 else 'or' }} {{ supported_methods[-1] }}"

  # --- Pre-flight Checks and Confirmation ---
  pre_tasks:
    # The prompt for 'topology' runs when interactive_mode is not defined or is true
    - name: Prompt for the topology
      ansible.builtin.pause:
        prompt: "Enter topology ({{ supported_topologies_pretty_print }})"
      register: prompt_result
      delegate_to: localhost
      run_once: true
      when: interactive_mode is not defined or interactive_mode | bool

    # Default 'topology' if not interactive or not provided
    - name: Set the topology fact
      ansible.builtin.set_fact:
        topology: "{{ prompt_result.user_input | default('') or topology | default('arbiter') }}"

    - name: Validate topology selection
      assert:
        that: ( prompt_result.user_input in supported_topologies )
        fail_msg: "Unsupported value, please select one of ({{ supported_topologies_pretty_print }})."
      when: interactive_mode is not defined or interactive_mode | bool

    - name: Prompt for the installation method
      ansible.builtin.pause:
        prompt: "Enter method ({{ supported_methods_pretty_print }})"
      register: prompt_result_method
      delegate_to: localhost
      run_once: true
      when: (interactive_mode is not defined or interactive_mode | bool) and (prompt_result.user_input == 'arbiter')

    - name: Validate method selection
      assert:
        that: ( prompt_result_method.user_input in supported_methods )
        fail_msg: "Unsupported value, please select one of ({{ supported_methods_pretty_print }})."
      when: (interactive_mode is not defined or interactive_mode | bool) and prompt_result_method and prompt_result.user_input == 'arbiter'

    # Default 'method' if not interactive
    - name: Set the method fact
      ansible.builtin.set_fact:
        method: "{{ prompt_result_method.user_input | default('ipi') }}"

    - name: Pre-load variables from the 'install-dev' role
      ansible.builtin.include_vars:
        dir: roles/dev-scripts/install-dev/vars
      run_once: true

    - name: CONFIRMATION - Display the chosen config file
      ansible.builtin.debug:
        msg: "The topology is '{{ topology }}' and method is '{{ method }}', so the selected script will be '{{ config_file[method] }}'"
      run_once: true
      # Confirmation runs when interactive_mode is not defined or is true
      when: interactive_mode is not defined or interactive_mode | bool

    - name: Wait for user to press Enter to continue
      ansible.builtin.pause:
        prompt: "Please verify the information above is correct. Press Enter to proceed."
      delegate_to: localhost
      run_once: true
      # Final confirmation pause runs when interactive_mode is not defined or is true
      when: interactive_mode is not defined or interactive_mode | bool

  roles:
    - config
    - dev-scripts/install-dev

  tasks:
    - name: "Final verification message"
      ansible.builtin.debug:
        msg: "Installation tasks have completed for topology '{{ topology }}'."

  post_tasks:
    - name: Setup and run redfish configuration
      include_tasks: roles/redfish/tasks/setup-and-run.yml
