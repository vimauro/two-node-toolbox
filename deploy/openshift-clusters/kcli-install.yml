---
# OpenShift Two-Node Cluster deployment using kcli
# This playbook deploys a two-node OpenShift cluster with fencing or arbiter configuration
# Defaults to fencing topology with non-interactive mode for automation-friendly execution

- hosts: all
  gather_facts: yes

  # Ensure required collections are installed:
  # ansible-galaxy collection install -r collections/requirements.yml
  collections:
    - community.libvirt
    - kubernetes.core
  
  # --- Variable Definitions ---
  vars:
    # Default to non-interactive mode to prevent prompts during automated runs
    # Set interactive_mode: true to enable prompts for manual execution
    interactive_mode: false
    
    # Default topology is fencing (can be overridden to 'arbiter' if needed, not supported at the moment)
    # This default ensures no prompt is triggered when interactive_mode is false
    topology: fencing

  # --- Pre-flight Checks and Confirmation ---
  pre_tasks:
    # The prompt for 'topology' runs ONLY when interactive_mode is true
    # With default interactive_mode: false, this prompt is skipped
    - name: Prompt for the topology
      ansible.builtin.pause:
        prompt: "Enter topology (arbiter or fencing)"
      register: prompt_result
      delegate_to: localhost
      run_once: true
      when: interactive_mode is not defined or interactive_mode | bool

    # Set topology from prompt result or use the default value
    # When interactive_mode is false, this uses the default 'fencing' topology
    - name: Set the topology fact
      ansible.builtin.set_fact:
        topology: "{{ prompt_result.user_input | default('') or topology | default('fencing') }}"

    - name: Pre-load variables from the 'kcli-install' role
      ansible.builtin.include_vars:
        dir: roles/kcli/kcli-install/vars
      run_once: true

    # Configuration display runs ONLY in interactive mode
    # With default interactive_mode: false, this debug output is skipped
    - name: CONFIRMATION - Display the chosen configuration
      ansible.builtin.debug:
        msg: |
          Topology: {{ topology }}
          Method: kcli (equivalent to dev-scripts IPI)
          Cluster: {{ test_cluster_name | default('ostest-kcli') }}
          Domain: {{ domain | default('karmalabs.corp') }}
          Version: {{ ocp_version | default('stable') }}/{{ ocp_tag | default('4.19') }}
      run_once: true
      # Confirmation runs when interactive_mode is not defined or is true
      when: interactive_mode is not defined or interactive_mode | bool

    # User confirmation pause runs ONLY in interactive mode
    # With default interactive_mode: false, this pause is skipped for automation
    - name: Wait for user to press Enter to continue
      ansible.builtin.pause:
        prompt: "Please verify the information above is correct. Press Enter to proceed."
      delegate_to: localhost
      run_once: true
      # Final confirmation pause runs when interactive_mode is not defined or is true
      when: interactive_mode is not defined or interactive_mode | bool

    # Run kcli-install prerequisites first (needed for kcli-redfish)
    - name: Run kcli-install prerequisites
      include_role:
        name: kcli/kcli-install
        tasks_from: prerequisites.yml

  roles:
    # Start ksushy BEFORE cluster installation (required for 4.20+)
    - role: kcli/kcli-redfish
      when: topology == "fencing"
    - kcli/kcli-install

  vars_files:
    - vars/main.yml

  tasks:
  # Setup proxy access as a separate step after cluster deployment
  - name: Setup proxy access
    include_role:
      name: proxy-setup
    vars:
      kubeconfig_path: "{{ ansible_user_dir }}/.kcli/clusters/{{ test_cluster_name }}/auth/kubeconfig"
      kubeadmin_password_path: "{{ ansible_user_dir }}/.kcli/clusters/{{ test_cluster_name }}/auth/kubeadmin-password"

  # Configure stonith fencing after cluster installation
  - name: Configure Redfish BMC simulation for fencing topology
    shell: ansible-playbook kcli-redfish.yml -i {{ inventory_file | default('inventory.ini') }}
    args:
      chdir: "{{ playbook_dir }}"
    delegate_to: localhost
    run_once: true
    when: topology == "fencing"

  - name: "Final verification message"
    ansible.builtin.debug:
      msg: |
        Installation tasks have completed for {{ topology }} topology.
        
        Next steps:
        1. Source the proxy environment from anywhere:
           source {{ playbook_dir }}/proxy.env
           (or from openshift-clusters directory: source proxy.env)
        2. Verify cluster access: oc get nodes
        3. Access the cluster console if needed